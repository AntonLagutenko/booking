<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Запись</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 960px;
      margin: 40px auto;
      padding: 0 20px;
      background: #f8fafc;
    }
    h1 { text-align: center; color: #16537e; }
    .container {
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr 2fr;
    }
    @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    label { display: block; margin: 0.8rem 0 0.4rem; font-weight: 500; }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 1.05rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .search-container { position: relative; }
    #employeeList {
      position: absolute; width: 100%; max-height: 260px; overflow-y: auto;
      background: white; border: 1px solid #ccc; border-radius: 6px;
      margin: 4px 0 0; padding: 0; list-style: none;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15); z-index: 10; display: none;
    }
    #employeeList li { padding: 10px 14px; cursor: pointer; }
    #employeeList li:hover, #employeeList li.selected { background: #dbeafe; }
    .slots {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px; margin-top: 1.2rem;
    }
    .slot {
      padding: 12px; text-align: center; border: 1px solid #d1d5db;
      border-radius: 8px; background: white; cursor: pointer; transition: all 0.12s;
    }
    .slot:hover:not(.booked) { background: #eff6ff; border-color: #3b82f6; }
    .slot.booked {
      background: #fee2e2; color: #991b1b; cursor: not-allowed;
      text-decoration: line-through; border-color: #fecaca;
    }
    #message { margin-top: 1.5rem; color: #166534; font-weight: 500; }
    #error { color: #991b1b; }

    .loading-dots-container {
      display: flex; justify-content: center; align-items: center; gap: 10px; padding: 5rem 0;
    }
    .loading-dot {
      width: 12px; height: 12px; background: #64748b; border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Стили для состояний процесса и успеха */
    .process-state, .success-state, .error-state {
      text-align: center; padding: 6rem 1rem; min-height: 300px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .success-state { color: #166534; }
    .success-state .icon { font-size: 6rem; margin-bottom: 1rem; }
    .error-state { color: #991b1b; }
    .error-state .icon { font-size: 5rem; margin-bottom: 1rem; }

    /* Кнопка "Новая запись" */
    .btn-new {
      margin-top: 1rem;
      padding: 10px 18px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn-new:hover { background: #1e40af; }
  </style>
</head>
<body>

<h1>Выберите сотрудника и дату</h1>

<div class="container">
  <div>
    <label for="employeeInput">Сотрудник</label>
    <div class="search-container">
      <input type="text" id="employeeInput" placeholder="Начните вводить фамилию..." autocomplete="off"/>
      <ul id="employeeList"></ul>
    </div>

    <label for="datePicker">Дата</label>
    <input type="date" id="datePicker"/>
  </div>

  <div>
    <h3>Доступные слоты</h3>
    <div id="slotsContainer" class="slots"></div>
    <div id="message"></div>
    <div id="error"></div>
  </div>
</div>

<script>
const CONFIG = {
  SCRIPT_URL: "https://script.google.com/macros/s/AKfycbycvzGct5s2WPd_XeKW2swweefuXSOex5pA5gjV-0M5lQ1ZadkE5Htq-WPDE2ggxDUJ/exec",
  EMPLOYEES: [
    "Иванов Сергей Петрович", "Петрова Анна Ивановна", "Сидоров Дмитрий Алексеевич",
    "Козлова Мария Викторовна", "Морозов Павел Николаевич", "Васильева Ольга Сергеевна"
  ].sort(),
  WORKING_START: 17,
  WORKING_END: 20,
  SLOT_MINUTES: 10
};

const ALL_SLOTS = (() => {
  const slots = [];
  for (let h = CONFIG.WORKING_START; h < CONFIG.WORKING_END; h++) {
    for (let m = 0; m < 60; m += CONFIG.SLOT_MINUTES) {
      slots.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`);
    }
  }
  return slots;
})();

let isUpdating = false;
const datePicker   = document.getElementById("datePicker");
const employeeInput = document.getElementById("employeeInput");
const slotsDiv     = document.getElementById("slotsContainer");
const list = document.getElementById("employeeList");
let currentEmployee = null;

// ─── Утилиты ────────────────────────────────────────
function normalizeTime(raw) {
  if (!raw) return null;
  if (raw instanceof Date && !isNaN(raw)) {
    return `${String(raw.getHours()).padStart(2,"0")}:${String(raw.getMinutes()).padStart(2,"0")}`;
  }
  let s = String(raw).trim();
  if (!s) return null;
  if (s.includes("GMT") || s.includes("1899")) {
    const match = s.match(/(\d{1,2}):(\d{2})/);
    if (match) return `${match[1].padStart(2,"0")}:${match[2]}`;
  }
  const parts = s.split(/[:.]/);
  if (parts.length < 2) return null;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (isNaN(h) || isNaN(m)) return null;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;
}

// ─── Поиск сотрудника ───────────────────────────────
function showSuggestions() {
  const val = employeeInput.value.trim().toLowerCase();
  list.innerHTML = "";
  list.style.display = "none";
  if (val.length < 1) return;
  const matches = CONFIG.EMPLOYEES.filter(n => n.toLowerCase().includes(val));
  if (!matches.length) return;
  matches.forEach(name => {
    const li = document.createElement("li");
    li.textContent = name;
    li.onclick = () => selectEmployee(name);
    list.appendChild(li);
  });
  list.style.display = "block";
}

function selectEmployee(name) {
  currentEmployee = name;
  employeeInput.value = name;
  list.style.display = "none";
  updateSlots();
}

employeeInput.addEventListener("input", showSuggestions);
employeeInput.addEventListener("focus", showSuggestions);
document.addEventListener("click", e => {
  if (!employeeInput.contains(e.target) && !list.contains(e.target)) {
    list.style.display = "none";
  }
});

// ─── Работа с датами и слотами ──────────────────────
datePicker.min = new Date().toISOString().split("T")[0];
datePicker.value = datePicker.min;

async function fetchBooked(employee, date, force = false) {
  try {
    const params = new URLSearchParams({ employee: encodeURIComponent(employee), date });
    if (force) params.append("_", Date.now());
    const res = await fetch(`${CONFIG.SCRIPT_URL}?${params}`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (json.status !== "ok") return new Set();
    const times = (json.booked || []).map(normalizeTime).filter(Boolean);
    return new Set(times);
  } catch (err) {
    console.error("fetchBooked:", err);
    return new Set();
  }
}

function showLoading() {
  slotsDiv.innerHTML = `
    <div class="loading-dots-container">
      <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
    </div>
    <p style="text-align:center; color:#6b7280; margin:1.5rem 0 0;">Загрузка слотов...</p>
  `;
}

function showEmpty() {
  slotsDiv.innerHTML = '<p style="color:#6b7280; text-align:center">Выберите сотрудника и дату</p>';
}

function renderSlots(bookedSet) {
  const frag = document.createDocumentFragment();
  ALL_SLOTS.forEach(time => {
    const el = document.createElement("div");
    el.className = "slot";
    el.textContent = time;
    if (bookedSet.has(time)) {
      el.classList.add("booked");
      el.title = "Занято";
    } else {
      el.title = "Свободно — кликните для записи";
      el.onclick = () => book(time, datePicker.value);
    }
    frag.appendChild(el);
  });
  slotsDiv.innerHTML = "";
  slotsDiv.appendChild(frag);
}

async function updateSlots() {
  if (isUpdating) return;
  isUpdating = true;
  showLoading();

  if (!currentEmployee || !datePicker.value) {
    showEmpty();
    isUpdating = false;
    return;
  }

  const booked = await fetchBooked(currentEmployee, datePicker.value);
  renderSlots(booked);
  isUpdating = false;
}

// ─── Вспомогательная функция сброса интерфейса ─────
function resetForNewBooking() {
  // разблокировать поля и вернуть плейсхолдер
  datePicker.disabled = false;
  employeeInput.disabled = false;
  employeeInput.placeholder = "Начните вводить фамилию...";
  // очистить выбор сотрудника/даты
  currentEmployee = null;
  employeeInput.value = "";
  list.style.display = "none";
  datePicker.value = datePicker.min;
  // показать пустое состояние слотов
  showEmpty();
}

// ─── Создание записи с блокировкой и процессом ──────
async function book(time, date) {
  if (!confirm(`Записаться ��а ${date} ${time} к ${currentEmployee}?`)) return;

  const client = prompt("Ваше ФИО")?.trim() || "—";
  const phone  = prompt("Телефон")?.trim();

  if (!phone) {
    alert("Укажите номер телефона");
    return;
  }

  // Блокируем поля ввода
  datePicker.disabled = true;
  employeeInput.disabled = true;
  employeeInput.placeholder = "Запись в процессе...";

  // Показываем индикатор процесса
  slotsDiv.innerHTML = `
    <div class="process-state">
      <div class="loading-dots-container" style="padding:3rem 0;">
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
      </div>
      <p style="font-size:1.25rem; margin-top:1rem; color:#166534;">
        Создаём запись...
      </p>
    </div>
  `;

  const payload = { date, time, employee: currentEmployee, client, phone };

  try {
    const res = await fetch(CONFIG.SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    if (data.status === "ok") {
      // Показываем успех ТОЛЬКО после ответа сервера
      slotsDiv.innerHTML = `
        <div class="success-state">
          <div class="icon">✔</div>
          <h2>Запись успешно создана!</h2>
          <p style="margin:1rem 0; font-size:1.1rem;">
            ${client}<br>
            ${phone}<br>
            ${date} в ${time}
          </p>
          <small style="color:#6b7280;">Спасибо за запись</small>
          <button id="newBookingBtn" class="btn-new">Новая запись</button>
        </div>
      `;
      // Привязка обработчика кнопки
      const btn = document.getElementById("newBookingBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          resetForNewBooking();
        });
      }
    } else {
      throw new Error(data.message || "Ошибка сервера");
    }
  } catch (err) {
    console.error(err);
    slotsDiv.innerHTML = `
      <div class="error-state">
        <div class="icon">✗</div>
        <h2>Не удалось создать запись</h2>
        <p>${err.message || "Ошибка связи"}</p>
      </div>
    `;
    // Можно разблокировать поля после ошибки, если нужно:
    datePicker.disabled = false;
    employeeInput.disabled = false;
    employeeInput.placeholder = "Начните вводить фамилию...";
  }
  // Поля остаются заблокированными после успешной записи до нажатия кнопки "Новая запись"
}

// ─── Инициализация ──────────────────────────────────
datePicker.addEventListener("change", updateSlots);
</script>
</body>
</html>

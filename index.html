<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Запись</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 960px;
      margin: 40px auto;
      padding: 0 20px;
      background: #f8fafc;
    }
    h1 { text-align: center; color: #16537e; }
    .container {
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr 2fr;
    }
    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; }
    }
    label { display: block; margin: 0.8rem 0 0.4rem; font-weight: 500; }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 1.05rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .search-container { position: relative; }
    #employeeList {
      position: absolute;
      width: 100%;
      max-height: 260px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 4px 0 0;
      padding: 0;
      list-style: none;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      z-index: 10;
      display: none;
    }
    #employeeList li {
      padding: 10px 14px;
      cursor: pointer;
    }
    #employeeList li:hover, #employeeList li.selected {
      background: #dbeafe;
    }
    .slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 1.2rem;
    }
    .slot {
      padding: 12px;
      text-align: center;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.12s;
    }
    .slot:hover:not(.booked) {
      background: #eff6ff;
      border-color: #3b82f6;
    }
    .slot.booked {
      background: #fee2e2;
      color: #991b1b;
      cursor: not-allowed;
      text-decoration: line-through;
      border-color: #fecaca;
    }
    #message { margin-top: 1.5rem; color: #166534; font-weight: 500; }
    #error { color: #991b1b; }

    .loading-dots-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 5rem 0;
    }
    .loading-dot {
      width: 12px;
      height: 12px;
      background: #64748b;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.4; }
      40%           { transform: scale(1); opacity: 1;   }
    }
  </style>
</head>
<body>

<h1>Выберите сотрудника и дату</h1>

<div class="container">
  <div>
    <label for="employeeInput">Сотрудник</label>
    <div class="search-container">
      <input type="text" id="employeeInput" placeholder="Начните вводить фамилию..." autocomplete="off"/>
      <ul id="employeeList"></ul>
    </div>

    <label for="datePicker">Дата</label>
    <input type="date" id="datePicker"/>
  </div>

  <div>
    <h3>Доступные слоты</h3>
    <div id="slotsContainer" class="slots"></div>
    <div id="message"></div>
    <div id="error"></div>
  </div>
</div>

<script>
const CONFIG = {
  SCRIPT_URL: "https://script.google.com/macros/s/AKfycbycvzGct5s2WPd_XeKW2swweefuXSOex5pA5gjV-0M5lQ1ZadkE5Htq-WPDE2ggxDUJ/exec",
  EMPLOYEES: [
    "Иванов Сергей Петрович",
    "Петрова Анна Ивановна",
    "Сидоров Дмитрий Алексеевич",
    "Козлова Мария Викторовна",
    "Морозов Павел Николаевич",
    "Васильева Ольга Сергеевна"
  ].sort(),
  WORKING_START: 17,
  WORKING_END: 20,
  SLOT_MINUTES: 10
};

const ALL_SLOTS = (() => {
  const slots = [];
  for (let h = CONFIG.WORKING_START; h < CONFIG.WORKING_END; h++) {
    for (let m = 0; m < 60; m += CONFIG.SLOT_MINUTES) {
      slots.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`);
    }
  }
  return slots;
})();

let isUpdating = false;
const datePicker = document.getElementById("datePicker");
const slotsDiv    = document.getElementById("slotsContainer");
const errorEl     = document.getElementById("error");
const messageEl   = document.getElementById("message");

let currentEmployee = null;

// ──────────────────────────────────────────────
// Утилиты
// ──────────────────────────────────────────────
function normalizeTime(raw) {
  if (!raw) return null;
  if (raw instanceof Date && !isNaN(raw)) {
    return `${String(raw.getHours()).padStart(2,"0")}:${String(raw.getMinutes()).padStart(2,"0")}`;
  }
  let s = String(raw).trim();
  if (!s) return null;
  if (s.includes("GMT") || s.includes("1899")) {
    const match = s.match(/(\d{1,2}):(\d{2})/);
    if (match) return `${match[1].padStart(2,"0")}:${match[2]}`;
  }
  const parts = s.split(/[:.]/);
  if (parts.length < 2) return null;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (isNaN(h) || isNaN(m)) return null;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;
}

// ──────────────────────────────────────────────
// Поиск сотрудника
// ──────────────────────────────────────────────
const input = document.getElementById("employeeInput");
const list  = document.getElementById("employeeList");

function showSuggestions() {
  const val = input.value.trim().toLowerCase();
  list.innerHTML = "";
  list.style.display = "none";
  if (val.length < 1) return;

  const matches = CONFIG.EMPLOYEES.filter(name => name.toLowerCase().includes(val));
  if (!matches.length) return;

  matches.forEach(name => {
    const li = document.createElement("li");
    li.textContent = name;
    li.onclick = () => selectEmployee(name);
    list.appendChild(li);
  });
  list.style.display = "block";
}

function selectEmployee(name) {
  currentEmployee = name;
  input.value = name;
  list.style.display = "none";
  updateSlots();
}

input.addEventListener("input", showSuggestions);
input.addEventListener("focus", showSuggestions);
document.addEventListener("click", e => {
  if (!input.contains(e.target) && !list.contains(e.target)) {
    list.style.display = "none";
  }
});

// ──────────────────────────────────────────────
// Загрузка занятых слотов
// ──────────────────────────────────────────────
async function fetchBooked(employee, date, force = false) {
  try {
    const params = new URLSearchParams({ employee: encodeURIComponent(employee), date });
    if (force) params.append("_", Date.now());

    const res = await fetch(`${CONFIG.SCRIPT_URL}?${params}`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const json = await res.json();
    if (json.status !== "ok") return new Set();

    const times = (json.booked || []).map(normalizeTime).filter(Boolean);
    return new Set(times);
  } catch (err) {
    console.error("fetchBooked error:", err);
    return new Set();
  }
}

// ──────────────────────────────────────────────
// Отрисовка и состояния
// ──────────────────────────────────────────────
function showLoading() {
  slotsDiv.innerHTML = `
    <div class="loading-dots-container">
      <div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>
    </div>
    <p style="text-align:center; color:#6b7280; margin:1.5rem 0 0;">Загрузка слотов...</p>
  `;
}

function showEmpty() {
  slotsDiv.innerHTML = '<p style="color:#6b7280; text-align:center">Выберите сотрудника и дату</p>';
}

function renderSlots(bookedSet) {
  const fragment = document.createDocumentFragment();
  ALL_SLOTS.forEach(time => {
    const el = document.createElement("div");
    el.className = "slot";
    el.textContent = time;

    if (bookedSet.has(time)) {
      el.classList.add("booked");
      el.title = "Занято";
    } else {
      el.title = "Свободно — кликните для записи";
      el.onclick = () => book(time, datePicker.value);
    }
    fragment.appendChild(el);
  });

  slotsDiv.innerHTML = "";
  slotsDiv.appendChild(fragment);
}

async function updateSlots() {
  if (isUpdating) return;
  isUpdating = true;

  showLoading();
  errorEl.textContent = "";
  messageEl.textContent = "";

  if (!currentEmployee || !datePicker.value) {
    showEmpty();
    isUpdating = false;
    return;
  }

  try {
    const booked = await fetchBooked(currentEmployee, datePicker.value);
    renderSlots(booked);
  } catch {
    slotsDiv.innerHTML = '<p style="color:#991b1b; text-align:center">Ошибка загрузки расписания</p>';
  } finally {
    isUpdating = false;
  }
}

// ──────────────────────────────────────────────
// Создание записи
// ──────────────────────────────────────────────
async function book(time, date) {
  if (!confirm(`Записаться на ${date} ${time} к ${currentEmployee}?`)) return;

  const client = prompt("Ваше ФИО")?.trim() || "—";
  const phone  = prompt("Телефон")?.trim()  || "—";

  const payload = { date, time, employee: currentEmployee, client, phone };

  try {
    const res = await fetch(CONFIG.SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    if (data.status === "ok") {
      alert("✅ Запись создана!");
      await updateSlots();
    } else {
      alert(`❌ ${data.message || "Ошибка сервера"}`);
    }
  } catch (err) {
    console.error("Ошибка записи:", err);
    alert("❌ Не удалось записаться. Попробуйте позже.");
  }
}

// ──────────────────────────────────────────────
// Инициализация
// ──────────────────────────────────────────────
datePicker.min = new Date().toISOString().split("T")[0];
datePicker.value = datePicker.min;
datePicker.addEventListener("change", updateSlots);
  </script>
</body>
</html>
